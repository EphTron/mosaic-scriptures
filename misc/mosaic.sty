\usepackage[activate={true,nocompatibility},final,tracking=true,kerning=true,spacing=true,factor=1100,stretch=10,shrink=10]{microtype}   % Better typography

\usepackage{lettrine}   % Add drop caps to chapter openings
\usepackage{graphicx}
\usepackage{ebgaramond}

\newcommand{\hsp}{\kern 1pt}    % for nested quotation marks

% Paragraph formatting
\renewcommand{\baselinestretch}{1.125}      % Allow paragraphs to breathe by spreading the lines further
\setlength{\parskip}{0pt}                   % Fixed space between paragraphs (i.e. disable variable parskip)
\setlength{\parindent}{1em}

% Donâ€™t add extra space after sentences
\frenchspacing

% Reduce widows/orphans
\widowpenalty=10000
\clubpenalty=10000

% Page size
\usepackage[
    paperheight=9in,
    paperwidth=6in,
    top=0.75in,
    bottom=0.75in,
    outer=0.75in,
    inner=0.875in
]{geometry}

% Reduce overfull \hbox{} warnings
\sloppy

% Contents page
\usepackage[titles]{tocloft}
\renewcommand{\cftchapfont}{\large\itshape}
\renewcommand{\cftchappagefont}{\normalfont}
\renewcommand{\numberline}[1]{}

% chapter headings
\renewcommand\thechapter{\Roman{chapter}}
\usepackage[center,sc]{titlesec}

% Define common commands for short stories
\newcommand{\ShortStoryTitle}[1]{\title{#1}}
\newcommand{\Authors}[1]{\def\CurrentAuthors{#1}}

% headers/footers
\usepackage{fancyhdr}
\setlength{\headheight}{14pt}
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}
\fancyhf[CFE,CFO]{\thepage}         % Set page numbers in the footer
%\fancyhead[LE,RO]{\thepage}        % Set page numbers in the left/right sides of the header
\fancyhead[CE]{\itshape\FormatAuthorsForChapter{\CurrentAuthors}} % Author name in middle of left-side page header
\fancyhead[CO]{\itshape\booktitle}  % Book title in middle of right-side page header

\usepackage{ifthen}  % Ensure this is loaded

\newcommand{\MosaicChapter}[4]{%
  % Determine the correct chapter title based on the language parameter
  \newcount\langchoice
  \ifthenelse{\equal{#1}{English}}{\langchoice=0}{%
    \ifthenelse{\equal{#1}{German}}{\langchoice=1}{%
      \ifthenelse{\equal{#1}{French}}{\langchoice=2}{%
        \langchoice=0  % Default to English if unknown
      }%
    }%
  }%
  \Authors{#4}
  % Use \ifcase to determine the localized chapter name
  \ifdefined\chapter
    \ifcase\langchoice
      \chapter{#2} % English - "Chapter"
    \or
      \def\ChapterName{Kapitel} % Case 1: German
      \chapter{#2} % German - "Kapitel"
    \or
      \chapter{#2} % French - "Chapitre"
    \else
      \chapter{#2} % Default fallback
    \fi
  \else
    \section*{#2} % Article class - Only show title, no "Kapitel" or "Chapter"
  \fi

  \begin{center}
    \par\noindent\rule{0.7\textwidth}{0.2pt}
  \end{center}

  % Centered author names
  \begin{center}
    \textit{\FormatAuthorsForChapter{\CurrentAuthors}}
  \end{center}

  % Display the introductory text in italics
  \begin{center}
    \itshape#3
  \end{center}

%  \vspace{2em}
}

% Define \Chapter to dynamically adapt to document class
\newcommand{\Chapter}[1]{
  \ifdefined\chapter
    \chapter{#1}
  \else
    \section*{#1}
  \fi
}

\usepackage{etoolbox}

% Macro to format the author list
\newcommand{\TitleFormatAuthors}[1]{%
    \def\formatted{}% Store formatted output
    \renewcommand{\do}[1]{%
        \ifx\formatted\empty
            \xdef\formatted{##1}% First author
        \else
            \xdef\formatted{\formatted\\ and\\ ##1}% Replace commas with " and "

            %{\itshape\Large \authornameOne\par}
    %\vspace{5pt}
        \fi
    }%
    \expandafter\docsvlist\expandafter{#1}%
    \formatted
}

% Macro to format authors correctly
\newcommand{\FormatAuthorsForTitle}[1]{%
    \def\formatted{}% Initialize storage for formatted names
    \newif\iffirstauthor
    \firstauthortrue % Flag for first author
    \renewcommand{\do}[1]{%
        \iffirstauthor
            \gdef\formatted{{\Large\itshape ##1}}% First author, no "and"
            \firstauthorfalse % Switch flag after first name
        \else
            \appto\formatted{\\{\large and}\\ {\Large\itshape ##1}}% "and" only for subsequent authors
        \fi
    }%
    \expandafter\docsvlist\expandafter{#1}%
    \noindent\formatted % Prevents leading spaces
}


% Macro to format the author list
\newcommand{\FormatAuthorsForChapter}[1]{%
    \def\formatted{}% Store formatted output
    \renewcommand{\do}[1]{%
        \ifx\formatted\empty
            \xdef\formatted{##1}% First author
        \else
            \xdef\formatted{\formatted\space and ##1}% Replace commas with " and "
        \fi
    }%
    \expandafter\docsvlist\expandafter{#1}%
    \formatted
}

